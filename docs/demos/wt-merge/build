#!/usr/bin/env python3
"""Build script for wt-merge demo GIF."""

import re
import subprocess
import sys
from pathlib import Path

# Add docs/demos/ to path for shared library
SCRIPT_DIR = Path(__file__).parent
DEMOS_DIR = SCRIPT_DIR.parent
sys.path.insert(0, str(DEMOS_DIR))

from shared import (
    DemoEnv, prepare_demo_repo,
    check_dependencies, setup_demo_output, build_shell_env, record_all_themes,
)

REPO_ROOT = DEMOS_DIR.parent.parent
OUT_DIR = SCRIPT_DIR / "out"
TAPE_TEMPLATE = SCRIPT_DIR / "demo.tape"

OUTPUT_GIFS = {
    "light": OUT_DIR / "wt-merge.gif",
    "dark": OUT_DIR / "wt-merge-dark.gif",
}


def prepare_repo(env: DemoEnv):
    """Set up the demo repository using shared setup plus wt-specific config."""
    prepare_demo_repo(env, REPO_ROOT)

    # wt-merge demo-specific: user config with llm commit generation
    config_dir = env.home / ".config" / "worktrunk"
    project_id = str(env.bare_remote).removesuffix(".git")
    (config_dir / "config.toml").write_text(f'''[commit-generation]
command = "llm"
args = ["-m", "claude-haiku-4.5"]

[projects."{project_id}"]
approved-commands = ["cargo nextest run"]
''')


def record_text(demo_env: DemoEnv):
    """Record text output by running demo commands."""
    # Extract commands from tape
    commands = []
    for line in TAPE_TEMPLATE.read_text().splitlines():
        if line.startswith("Type "):
            cmd = line[5:].strip().strip('"').strip("'")
            # Skip setup commands
            if not any(cmd.startswith(p) for p in ["set -gx", "export ", "eval ", "cd ", "clear", "exit", "starship init", "wt config shell init"]):
                commands.append(cmd)

    env = build_shell_env(demo_env, REPO_ROOT, extra={
        "COLUMNS": "160",
        "NEXTEST_STATUS_LEVEL": "none",
        "NEXTEST_FINAL_STATUS_LEVEL": "flaky",
        "NEXTEST_NO_FAIL_FAST": "1",
    })

    # Run commands and capture output using fish with shell init
    script = "wt config shell init fish | source\n"
    for cmd in commands:
        script += f'{cmd}\n'
        if cmd.startswith("wt merge"):
            script += 'sleep 2\n'

    result = subprocess.run(
        ["fish", "-c", script],
        cwd=demo_env.repo, env=env,
        capture_output=True, text=True
    )
    output = result.stdout + result.stderr

    # Clean output
    clean = re.sub(r"\x1B\[[0-9;?]*[A-Za-z]", "", output)  # Strip ANSI
    clean = re.sub(r"[\x00-\x08\x0b\x0c\x0e-\x1f\x7f]", "", clean)  # Strip control chars
    clean = clean.replace("^D", "")

    (OUT_DIR / "run.txt").write_text(clean)


def main():
    check_dependencies(["wt", "vhs", "starship"])
    setup_demo_output(OUT_DIR)

    # Create separate environments for text and VHS recording
    text_env = DemoEnv(name="text", out_dir=OUT_DIR, repo_name="acme")
    vhs_env = DemoEnv(name="vhs", out_dir=OUT_DIR, repo_name="acme")

    prepare_repo(text_env)
    record_text(text_env)

    prepare_repo(vhs_env)
    record_all_themes(vhs_env, TAPE_TEMPLATE, OUTPUT_GIFS, REPO_ROOT)

    print(f"\nText log saved to {OUT_DIR / 'run.txt'}")


if __name__ == "__main__":
    main()
